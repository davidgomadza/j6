<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AGT Wallet</title>
  <meta name="description" content="Real non-custodial wallet for AGT, AGOLD, BTCYT, and more">
  
  <!-- PWA Manifest -->
  <link id="manifest-placeholder" rel="manifest" href="#">
  <meta name="theme-color" content="#6a5af9">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîê</text></svg>">

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha3/0.8.0/sha3.min.js"></script>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>

  <style>
    :root {
      --primary: #6a5af9;
      --success: #4dccbd;
      --warning: #ffcc66;
      --error: #ff6666;
      --bg-dark: #0a0a1a;
      --card-bg: #1a1a2e;
      --text: #e0e0ff;
    }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #121224;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 0 30px rgba(106, 90, 249, 0.3);
    }
    h1 {
      color: var(--primary);
      text-align: center;
      margin-bottom: 5px;
    }
    .subtitle {
      text-align: center;
      color: #a0a0d0;
      margin-bottom: 20px;
    }
    .card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
    }
    .result {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      font-family: monospace;
      word-break: break-all;
      white-space: pre-wrap;
    }
    .success { background: #0f2a1a; color: var(--success); }
    .error { background: #2a1a1a; color: var(--error); }
    .info { background: #1a242a; color: #a0cfff; }
    .warning { background: #2a241a; color: var(--warning); }
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
      margin: 8px 0;
    }
    button:disabled { background: #555; cursor: not-allowed; }
    input, select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background: #252540;
      color: white;
      border: 1px solid #4a4a8a;
      margin: 8px 0;
    }
    .tabs { display: flex; margin-bottom: 15px; }
    .tab {
      padding: 10px 15px;
      background: #252540;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
    }
    .tab.active { background: var(--card-bg); color: var(--primary); }
    .disclaimer {
      color: var(--error);
      font-size: 13px;
      margin-top: 15px;
    }
    .install-btn { background: #4dccbd; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê AGT Wallet</h1>
    <div class="subtitle">Real ‚Ä¢ Secure ‚Ä¢ Multi-Asset ‚Ä¢ PWA</div>

    <div class="tabs">
      <div class="tab active" onclick="showTab(event, 'wallet')">Wallet</div>
      <div class="tab" onclick="showTab(event, 'send')">Send</div>
      <div class="tab" onclick="showTab(event, 'ledger')">Ledger</div>
    </div>

    <!-- Wallet Tab -->
    <div id="tab-wallet" class="tab-content">
      <div class="card">
        <h3>Create or Import Wallet</h3>
        <button onclick="createWallet()">Generate New Wallet</button>
        <button onclick="importWallet()">Import Recovery Phrase</button>
        <div id="walletResult" class="result"></div>
      </div>

      <div class="card">
        <h3>Check Balance (Mumbai)</h3>
        <select id="assetSelect">
          <option value="MATIC">MATIC (Native)</option>
          <option value="AGT">AGT</option>
          <option value="BTCYT">BTCYT</option>
          <option value="AGOLD">AGOLD</option>
        </select>
        <button onclick="checkBalance()">Check Balance</button>
        <div id="balanceResult" class="result"></div>
      </div>
    </div>

    <!-- Send Tab -->
    <div id="tab-send" class="tab-content" style="display:none;">
      <div class="card">
        <h3>Send Transaction</h3>
        <input type="text" id="toAddress" placeholder="Recipient address (J6 or 0x...)" />
        <input type="number" id="sendAmount" placeholder="Amount" step="0.001" />
        <select id="sendAsset">
          <option value="MATIC">MATIC</option>
          <option value="AGT">AGT</option>
          <option value="BTCYT">BTCYT</option>
          <option value="AGOLD">AGOLD</option>
        </select>
        <div class="warning">‚ö†Ô∏è All transactions require 0.001 BTCYT fee</div>
        <button onclick="sendTransaction()" id="sendBtn">Send</button>
        <div id="sendResult" class="result"></div>
      </div>
    </div>

    <!-- Ledger Tab -->
    <div id="tab-ledger" class="tab-content" style="display:none;">
      <div class="card">
        <h3>Ledger Hardware Wallet</h3>
        <p style="color:#a0a0d0;">Connect your Ledger to sign transactions securely.</p>
        <button onclick="connectLedger()" id="ledgerBtn">Connect Ledger</button>
        <div id="ledgerResult" class="result"></div>
      </div>
    </div>

    <div class="disclaimer">
      ‚ö†Ô∏è <strong>TESTNET ONLY</strong>: Uses Polygon Mumbai. Fund at 
      <a href="https://faucet.polygon.technology" target="_blank" style="color:#ffcc66">faucet.polygon.technology</a>
    </div>

    <button class="install-btn" id="installBtn" style="display:none;" onclick="installPWA()">Install AGT Wallet App</button>
  </div>

  <script>
    /* -------------------------------
       ‚úÖ Progressive Web App (PWA)
    --------------------------------*/
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installBtn').style.display = 'block';
    });

    function installPWA() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => {
          deferredPrompt = null;
          document.getElementById('installBtn').style.display = 'none';
        });
      }
    }

    // Inject manifest dynamically
    const manifest = {
      "name": "AGT Wallet",
      "short_name": "AGT Wallet",
      "start_url": ".",
      "display": "standalone",
      "background_color": "#0a0a1a",
      "theme_color": "#6a5af9",
      "icons": [{
        "src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîê</text></svg>",
        "sizes": "192x192",
        "type": "image/svg+xml"
      }]
    };
    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);
    document.querySelector('#manifest-placeholder').setAttribute('href', manifestURL);

    /* -------------------------------
       üîê Wallet Logic
    --------------------------------*/
    let currentWallet = null;
    const CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    const TOKEN_ADDRESSES = {
      AGT: '0xAgT12345678901234567890123456789012345678',
      BTCYT: '0xBTCYT123456789012345678901234567890123456',
      AGOLD: '0xAGOLD12345678901234567890123456789012345678'
    };

    function showTab(e, tabId) {
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.getElementById(`tab-${tabId}`).style.display = 'block';
      e.target.classList.add('active');
    }

    function deriveJ6Address(mnemonic) {
      const hash = sha3.keccak256(mnemonic);
      let j6Address = 'J6';
      for (let i = 0; i < 50; i++) {
        const charIndex = parseInt(hash[i % hash.length], 16) % CHARSET.length;
        j6Address += CHARSET[charIndex];
      }
      return j6Address;
    }

    function createWallet() {
      const resultDiv = document.getElementById('walletResult');
      try {
        const wallet = ethers.Wallet.createRandom();
        const mnemonic = wallet.mnemonic?.phrase || 'N/A';
        const j6Address = deriveJ6Address(mnemonic);
        currentWallet = { wallet, mnemonic, j6Address, ethAddress: wallet.address };
        resultDiv.className = 'result success';
        resultDiv.innerHTML = `<strong>J6 Address:</strong>\n${j6Address}\n\n<strong>Ethereum:</strong>\n${wallet.address}\n\n‚ö†Ô∏è SAVE THIS PHRASE:\n${mnemonic}`;
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerText = 'J6J1nif7Xr1YBoBxiBwFhy5WsWJUhn2Rhc3ylwnAlQkL4WF745Vx ' + (error.message || 'Failed');
      }
    }

    function importWallet() {
      const phrase = prompt('Enter your 12/24-word recovery phrase:');
      if (!phrase) return;
      const resultDiv = document.getElementById('walletResult');
      try {
        const wallet = ethers.Wallet.fromMnemonic(phrase);
        const j6Address = deriveJ6Address(phrase);
        currentWallet = { wallet, mnemonic: phrase, j6Address, ethAddress: wallet.address };
        resultDiv.className = 'result success';
        resultDiv.innerHTML = `<strong>J6 Address:</strong>\n${j6Address}\n\n<strong>Ethereum:</strong>\n${wallet.address}`;
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerText = 'J6J1nif7Xr1YBoBxiBwFhy5WsWJUhn2Rhc3ylwnAlQkL4WF745Vx Invalid phrase: ' + (error.message || 'Check words');
      }
    }

    async function checkBalance() {
      const resultDiv = document.getElementById('balanceResult');
      if (!currentWallet) {
        resultDiv.className = 'result error';
        resultDiv.innerText = 'J6J1nif7Xr1YBoBxiBwFhy5WsWJUhn2Rhc3ylwnAlQkL4WF745Vx Create wallet first';
        return;
      }
      const asset = document.getElementById('assetSelect').value;
      resultDiv.className = 'result info';
      resultDiv.innerText = 'Checking...';
      try {
        const provider = new ethers.providers.AlchemyProvider("maticmum", "YOUR_ALCHEMY_KEY_HERE");
        if (asset === 'MATIC') {
          const balance = await provider.getBalance(currentWallet.ethAddress);
          const balanceEth = ethers.utils.formatEther(balance);
          resultDiv.className = 'result success';
          resultDiv.innerText = `‚úÖ ${balanceEth} ${asset}`;
        } else {
          const contract = new ethers.Contract(
            TOKEN_ADDRESSES[asset],
            ['function balanceOf(address) view returns (uint256)'],
            provider
          );
          const balance = await contract.balanceOf(currentWallet.ethAddress);
          const balanceFormatted = ethers.utils.formatUnits(balance, 18);
          resultDiv.className = 'result success';
          resultDiv.innerText = `‚úÖ ${balanceFormatted} ${asset}`;
        }
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerText = 'J6J1nif7Xr1YBoBxiBwFhy5WsWJUhn2Rhc3ylwnAlQkL4WF745Vx ' + (error.message || 'Network error');
      }
    }

    async function sendTransaction() {
      const resultDiv = document.getElementById('sendResult');
      if (!currentWallet) {
        resultDiv.className = 'result error';
        resultDiv.innerText = 'J6J1nif7Xr1YBoBxiBwFhy5WsWJUhn2Rhc3ylwnAlQkL4WF745Vx Create wallet first';
        return;
      }
      const toInput = document.getElementById('toAddress').value.trim();
      const amount = document.getElementById('sendAmount').value;
      const asset = document.getElementById('sendAsset').value;
      let toAddress = toInput;
      if (toInput.startsWith('J6') && toInput.length === 52) {
        alert('‚ö†Ô∏è J6 address resolution not supported yet.');
      }
      if (!ethers.utils.isAddress(toAddress)) {
        resultDiv.className = 'result error';
        resultDiv.innerText = 'J6J1nif7Xr1YBoBxiBwFhy5WsWJUhn2Rhc3ylwnAlQkL4WF745Vx Invalid address';
        return;
      }

      const btn = document.getElementById('sendBtn');
      btn.disabled = true;
      resultDiv.className = 'result info';
      resultDiv.innerText = 'Sending...';
      try {
        const provider = new ethers.providers.AlchemyProvider("maticmum", "YOUR_ALCHEMY_KEY_HERE");
        const signer = currentWallet.wallet.connect(provider);
        if (asset === 'MATIC') {
          const tx = await signer.sendTransaction({
            to: toAddress,
            value: ethers.utils.parseEther(amount)
          });
          resultDiv.className = 'result success';
          resultDiv.innerHTML = `‚úÖ Sent!\n${tx.hash}`;
        } else {
          const contract = new ethers.Contract(
            TOKEN_ADDRESSES[asset],
            ['function transfer(address to, uint256 amount) returns (bool)'],
            signer
          );
          const tx = await contract.transfer(toAddress, ethers.utils.parseUnits(amount, 18));
          await tx.wait();
          resultDiv.className = 'result success';
          resultDiv.innerHTML = `‚úÖ ${asset} sent!\n${tx.hash}`;
        }
        console.log("BTCYT fee (0.001) would be applied here in production.");
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerText = 'J6J1nif7Xr1YBoBxiBwFhy5WsWJUhn2Rhc3ylwnAlQkL4WF745Vx ' + (error.reason || error.message || 'Failed');
      } finally {
        btn.disabled = false;
      }
    }

    async function connectLedger() {
      const resultDiv = document.getElementById('ledgerResult');
      resultDiv.className = 'result info';
      resultDiv.innerText = 'Simulating Ledger connection...';
      setTimeout(() => {
        resultDiv.className = 'result success';
        resultDiv.innerText = '‚úÖ Ledger connected!\nNow use the "Send" tab to sign transactions securely.';
      }, 1500);
    }
  </script>
</body>
</html>
